(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram",o="GET",n="POST",r=(e,t,o,n)=>{const r=new XMLHttpRequest;return r.responseType="json",r.open(t,e),r.addEventListener("load",(()=>{200===r.status?o(r.response):n("Статус ответа: "+r.status+" "+r.statusText)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+r.timeout+"мс")})),r.timeout=1e4,r};window.api={loadData:(t,n)=>{r(e,o,t,n).send()},uploadData:(e,o,s)=>{r(t,n,e,o).send(s)}}})(),window.utils={getEffectValue:e=>.03*e,getNumDublicate:(e,t)=>{let o=0;return e.forEach((e=>{e===t&&o++})),o},buttonToggle:(e,t,o)=>{t.forEach((e=>{e.classList.remove(o)})),e.target.classList.add(o)},debounce:e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__cancel"),o=document.querySelector("#picture").content.querySelector(".picture"),n=document.querySelector(".pictures"),r=o=>{"Escape"!==o.key&&"click"!==o.type||(document.body.classList.remove("modal-open"),e.classList.add("hidden"),t.removeEventListener("click",r),document.removeEventListener("keydown",r))};window.gallery={renderAll:s=>{(e=>{for(let t=0;t<e.length;t++){const r=o.cloneNode(!0),s=r.querySelector("img"),i=r.querySelector(".picture__comments"),l=r.querySelector(".picture__likes");s.src=e[t].url,i.textContent=e[t].comments.length,l.textContent=e[t].likes,n.appendChild(r)}})(s),document.querySelectorAll(".picture").forEach(((o,n)=>{o.addEventListener("click",(()=>{window.picture.renderBigPicture(s[n]),document.body.classList.add("modal-open"),e.classList.remove("hidden"),t.addEventListener("click",r),document.addEventListener("keydown",r)}))}))},onErrorDataLoad:e=>{const t=document.createElement("div");t.style="position: absolute;\n  z-index: 100;\n  margin: 0 30%;\n  background: grey;\n  top: 40vh;\n  font-size: 26px;\n  padding: 30px 10px 30px 10px;\n  border: 7px solid darkgrey;\n  border-radius: 10px;\n  min-width: 41%;\n  text-align: center;",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e="border: 3px solid crimson",t="Escape",o=/^#[А-Яа-яA-Za-z0-9]{1,19}$/,n=document.querySelector("main"),r=document.querySelector(".img-upload__form"),s=r.querySelector("#upload-file"),i=r.querySelector("#effect-none"),l=document.querySelector(".scale__control--value"),c=document.querySelector(".img-upload__preview"),d=document.querySelector(".text__hashtags"),a=document.querySelector(".text__description"),u=document.querySelector("#success").content.querySelector(".success"),m=document.querySelector("#error").content.querySelector(".error"),p=e=>{const o=n.querySelector(".success"),r=o.querySelector(".success__button");e.target!==o&&e.target!==r&&e.key!==t||(n.removeChild(n.lastChild),document.removeEventListener("keydown",p))},f=e=>{const o=n.querySelector(".error"),r=n.querySelector(".error__button");e.target!==o&&e.target!==r&&e.key!==t||(n.removeChild(n.lastChild),document.removeEventListener("keydown",f))};window.form={node:r,validateHashtags:()=>{const t=d.value.split(" ").filter((e=>""!==e));if(d.setCustomValidity(""),d.style.border="none",t.length>5)return d.setCustomValidity("Максимальное количество хэштегов - не более пяти"),void(d.style=e);for(let n of t){if(n.length>20)return d.setCustomValidity("Максимальное количество знаков в хэштеге - не более 20 "+n),void(d.style=e);if(window.utils.getNumDublicate(t,n)>1)return d.setCustomValidity("Хештеги не должны повторяться - удалите один из "+n),void(d.style=e);if(n&&!o.test(n))return d.setCustomValidity("Хештег "+n+" должен начинаться с # и состоять из букв/цифр"),void(d.style=e)}},validateComment:()=>{a.setCustomValidity(""),a.textLength>140&&(a.setCustomValidity("Длина комментария должна быть не более 140 символов"),d.style=e)},getCustomSettings:e=>{window.preview.closeModal(e),s.value="",l.value="100%",c.style.transform="scale(1)",c.className="img-upload__preview",c.style.removeProperty("filter"),d.value="",a.value="",i.checked=!0},onSuccessUpload:()=>{const e=u.cloneNode(!0);n.appendChild(e),n.querySelector(".success").addEventListener("click",p),document.addEventListener("keydown",p)},onErrorUpload:()=>{const e=m.cloneNode(!0);n.appendChild(e),n.querySelector(".error").addEventListener("click",f),document.addEventListener("keydown",f)},reset:()=>{d.setCustomValidity(""),d.style.border="none",a.setCustomValidity("")}}})(),(()=>{const e=document.querySelector(".img-filters"),t=document.querySelectorAll(".img-filters__button");let o=[];const n=window.utils.debounce((e=>{var t;t=e,document.querySelectorAll(".picture").forEach((e=>{e.remove()})),window.gallery.renderAll(t)}));t.forEach((e=>{e.addEventListener("click",(r=>{switch(window.utils.buttonToggle(r,t,"img-filters__button--active"),e.id){case"filter-discussed":n(o.slice().sort(((e,t)=>t.comments.length-e.comments.length)));break;case"filter-random":n(o.slice().sort((()=>.5-Math.random())).slice(0,10));break;default:n(o)}}))})),window.filter={getPrimaryData:t=>{o=t,o.length>0&&e.classList.remove("img-filters--inactive")}}})(),(()=>{const e="hidden",t=document.querySelector(".big-picture"),o=document.querySelector(".big-picture img"),n=t.querySelector(".likes-count"),r=t.querySelector(".comments-count"),s=t.querySelector(".social__comments"),i=t.querySelector(".social__caption"),l=t.querySelector(".social__comment-count"),c=t.querySelector(".comments-loader");let d,a=[];const u=e=>{const t=document.createDocumentFragment();e.forEach((e=>{const o=document.createElement("li");o.classList.add("social__comment");const n=document.createElement("img");n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name,n.width=35,n.height=35,o.appendChild(n);const r=document.createElement("p");r.classList.add("social__text"),r.textContent=e.message,o.appendChild(r),t.appendChild(o)})),s.appendChild(t)};c.addEventListener("click",(()=>{a.length>5?(d+=5,u(a.slice(0,5)),a.splice(0,5),l.innerHTML=`${d} из <span class='comments-count'>${r.textContent}</span> комментариев`):(u(a),a.splice(),c.classList.add(e),l.innerHTML=`${r.textContent} из <span class='comments-count'>${r.textContent}</span> комментариев`)})),window.picture={renderBigPicture:t=>{for(o.src=t.url,n.textContent=t.likes,r.textContent=t.comments.length,i.textContent=t.description;s.firstChild;)s.removeChild(s.firstChild);d=0,a=t.comments.slice(),a.length>5?(u(a.slice(0,5)),a.splice(0,5),c.classList.remove(e),d=5,l.innerHTML=`${d} из <span class='comments-count'>${t.comments.length}</span> комментариев`):(u(a),c.classList.add(e),l.innerHTML=`${t.comments.length} из <span class='comments-count'>${t.comments.length}</span> комментариев`)}}})(),(()=>{const e=window.form.node.querySelector(".effect-level__pin"),t=window.form.node.querySelector(".effect-level__depth"),o=window.form.node.querySelector(".effect-level__value"),n=window.form.node.querySelector(".img-upload__preview"),r=window.form.node.querySelector(".effect-level__line"),s=n=>{e.style.left=n+"%",t.style.width=n+"%",o.value=Math.round(n)};window.slider={initSlider:()=>{e.addEventListener("mousedown",(t=>{t.preventDefault();let i=t.clientX;const l=t=>{t.preventDefault();let l=i-t.clientX;i=t.clientX;let c=(e.offsetLeft-l)/(r.offsetWidth/100);c>=100?c=100:c<=0&&(c=0),s(c),document.querySelectorAll(".effects__radio").forEach((e=>{if(e.checked)switch(e.id){case"effect-none":n.style.filter="none";break;case"effect-chrome":n.style.filter="grayscale("+o.value/100+")";break;case"effect-sepia":n.style.filter="sepia("+o.value/100+")";break;case"effect-marvin":n.style.filter="invert("+o.value+"%)";break;case"effect-phobos":n.style.filter="blur("+window.utils.getEffectValue(o.value)+"px)";break;case"effect-heat":n.style.filter="brightness("+window.utils.getEffectValue(o.value)+")"}}))},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",c)}))},getPinPosition:s}})(),(()=>{const e=100,t=window.form.node.querySelector(".img-upload__overlay"),o=window.form.node.querySelector(".scale__control--smaller"),n=window.form.node.querySelector(".scale__control--bigger"),r=window.form.node.querySelector(".scale__control--value"),s=window.form.node.querySelector(".img-upload__preview"),i=window.form.node.querySelector(".img-upload__effect-level"),l=e=>{"Escape"!==e.key&&"click"!==e.type&&"submit"!==e.type||(document.body.classList.remove("modal-open"),t.classList.add("hidden"),s.className="img-upload__preview",s.style.removeProperty("filter"),s.style.transform="scale(1)",d=100),document.removeEventListener("keydown",l)},c=e=>{r.value=e+"%",s.style.transform="scale("+e/100+")"};let d=parseInt(r.value,10);s.style.transform="scale("+d/100+")",o.addEventListener("click",(()=>{25!==d&&(d-=25,c(d))})),n.addEventListener("click",(()=>{100!==d&&(d+=25,c(d))})),document.querySelectorAll(".effects__radio").forEach((t=>{t.addEventListener("change",(()=>{switch(s.className="img-upload__preview",s.style.removeProperty("filter"),i.classList.remove("hidden"),t.id){case"effect-none":i.classList.add("hidden"),s.className="img-upload__preview";break;case"effect-chrome":s.classList.add("effects__preview--chrome"),window.slider.getPinPosition(e);break;case"effect-sepia":s.classList.add("effects__preview--sepia"),window.slider.getPinPosition(e);break;case"effect-marvin":s.classList.add("effects__preview--marvin"),window.slider.getPinPosition(e);break;case"effect-phobos":s.classList.add("effects__preview--phobos"),window.slider.getPinPosition(e);break;case"effect-heat":s.classList.add("effects__preview--heat"),window.slider.getPinPosition(e)}}))})),window.preview={showModal:()=>{document.body.classList.add("modal-open"),t.classList.remove("hidden"),i.classList.add("hidden"),document.addEventListener("keydown",l)},closeModal:l}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("body"),o=document.querySelector(".img-upload__form"),n=o.querySelector("#upload-file"),r=o.querySelector(".img-upload__preview img"),s=o.querySelector(".img-upload__overlay");n.addEventListener("change",(o=>{const i=o.target.files[0],l=i.name.toLowerCase();if(e.some((e=>l.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{s.classList.remove("hidden"),t.classList.add("modal-open"),r.src=e.result})),e.readAsDataURL(i)}else n.value=""}))})(),(()=>{const e=document.querySelector("#upload-file"),t=document.querySelector("#upload-cancel"),o=document.querySelector(".text__hashtags"),n=document.querySelector(".text__description");window.api.loadData((e=>{window.gallery.renderAll(e),window.filter.getPrimaryData(e)}),window.gallery.onErrorDataLoad),e.addEventListener("change",window.preview.showModal),t.addEventListener("click",window.preview.closeModal),window.slider.initSlider(),o.addEventListener("input",window.form.validateHashtags),n.addEventListener("input",window.form.validateComment),window.form.node.addEventListener("submit",(e=>{window.api.uploadData(window.form.onSuccessUpload,window.form.onErrorUpload,new FormData(window.form.node),window.form.getCustomSettings(e)),e.preventDefault()})),window.form.node.addEventListener("reset",window.form.reset)})()})();